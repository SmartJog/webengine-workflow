{% extends "workflow/base.html" %}
{% load parse_ticket %}
{% load smart_if %}

{% block optional_js %}
<script src="/medias/workflow/js/document_ready_workflow_instance.js" type="text/javascript"></script>
<script src="/medias/workflow/js/progressbar.js" type="text/javascript"></script>
<script src="/medias/workflow/js/shortcut.js" type="text/javascript"></script>
<script src="/medias/workflow/js/common.js" type="text/javascript"></script>

<script src="/javascript/underscore/underscore.min.js" type="text/javascript"></script>
<script src="/javascript/backbone/backbone.min.js" type="text/javascript"></script>
<script src="/javascript/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
{% endblock %}

{% block title %}{{ workflowinstance }}{% endblock %}

{% block content %}
<script type="text/javascript">
/* Global variables */
var gl_total = {{ counter.Total }};
var gl_failed = {{ counter.Failed }};
var gl_success = {{ counter.Success }};
var gl_taken = {{ counter.Taken }};
var gl_untaken = {{ counter.Free }};
var gl_not_solved = {{ counter.NotSolved }};
var gl_mine = {{ counter.Mine }};
/* ***** */
</script>
<div class="progress_workflow">
    <div id="progress_bar">
    </div>
    <div class="progress_bar_stats">
	<ul>
	    <li><span id="stats-success"></span></li>
	    <li><span id="stats-failed"></span></li>
	    <li><span id="stats-unsolved"></span></li>
	</ul>
    </div>
</div>

<div class="filters_workflow">
    <label><input type="radio" id="filters-all" onClick="$(location).attr('href','{% url workflow-workflowinstance-show workflowinstance.id display.all %}');" /><span></span></label>
    <label><input type="radio" id="filters-mine" onClick="$(location).attr('href','{% url workflow-workflowinstance-show workflowinstance.id display.mine %}');" /><span></span></label>
    <label><input type="radio" id="filters-untaken" onClick="$(location).attr('href','{% url workflow-workflowinstance-show workflowinstance.id display.untaken %}');" /><span></span></label>
    <label><input type="radio" id="filters-taken" onClick="$(location).attr('href','{% url workflow-workflowinstance-show workflowinstance.id display.taken %}');" /><span></span></label>
    <label><input type="radio" id="filters-successful" onClick="$(location).attr('href','{% url workflow-workflowinstance-show workflowinstance.id display.successful %}');" /><span></span></label>
    <label><input type="radio" id="filters-failed" onClick="$(location).attr('href','{% url workflow-workflowinstance-show workflowinstance.id display.failed %}');" /><span></span></label>
</div>

<div class="categories_table_workflow" id="workflowinstance_id-{{ workflowinstance.id }}">
<div id="sortable">
{% for id_category in order %}
{% for category in categories %}
{% ifequal id_category category.id %}
<table class="category_workflow" id="category_id-{{ category.id }}">
	<tr class="category-header">
        <th> -{{ category.name }} </th>
        <td class="take_untake_group" id="category_group-{{category.id}}">
            <a class="take-group" title="Take all items of the category">take</a>&nbsp;/&nbsp;
			<a class="untake-group" title="Untake all items of the category">untake</a>
		</td>
	</tr>
{% for workflowinstanceitem in category.workflowinstanceitems %}
	<tr class="highlight {% if forloop.counter|divisibleby:2 %}{% else %}odd_line{% endif %}">
    <td id="label-item-{{ workflowinstanceitem.id }}" class="label">
		<a class="label_item" title="Label item">{{ forloop.counter }} - {{ workflowinstanceitem.item.label }}</a>
		{% for URL in workflowinstanceitem.item.label|link_ticket %}
			{% ifequal forloop.counter 1 %}|&nbsp;{% endifequal %}
			<a class="urls" href="{{ URL }}" alt="Ticket {{ URL }}">{{ URL|get_ticket_name }}</a>{% if not forloop.last %},{% endif %}
        {% endfor %}
	</td>

	{% ifequal workflowinstanceitem.assigned_to None %}
		<td class="take-item owner-{{ workflowinstanceitem.assigned_to_id }}" id="take-item-{{ workflowinstanceitem.id }}">
			<a title="Take item">take</a>
		</td>
	{% else %}
		<td class="untake-item owner-{{ workflowinstanceitem.assigned_to_id }}" id="untake-item-{{ workflowinstanceitem.id }}">
			{{ workflowinstanceitem.assigned_to }}
			<a title="Reset owner of item">
			<img src="/medias/workflow/img/untake.png" />
			</a>
		</td>
	{% endifequal %}

	<td id="action-shortcuts-{{ workflowinstanceitem.id }}" class="state-item-{{ workflowinstanceitem.validation }} shortcut-cell">
		{% ifequal validations.0 workflowinstanceitem.validation %}
			<a title="Item is validated">
			<img src="/medias/workflow/img/validation_OK.png" alt="enabled" />
			</a>
		{% else %}
            <a class="shortcut-disabled-OK shortcut" title="Click to validate">
			<img src="/medias/workflow/img/validation_OK_disabled.png" alt="enabled" />
			</a>
		{% endifequal %}

		{% if validations.1.label == workflowinstanceitem.validation.label or validations.2.label == workflowinstanceitem.validation.label%}
			<a title="Item is untested"> ? </a>
		{% else %}
			<a class="shortcut-disabled-None shortcut" title="Reset item validation"> ? </a>
		{% endif %}

		{% ifequal validations.1 workflowinstanceitem.validation %}
			<a title="Item is broken">
			<img src="/medias/workflow/img/validation_KO.png" alt="enabled" />
			</a>
		{% else %}
            <a class="shortcut-disabled-KO shortcut" title="Click to mark as broken">
			<img src="/medias/workflow/img/validation_KO_disabled.png" alt="enabled" />
			</a>
		{% endifequal %}

	</td>
	</tr>
    <tr id="detail-item-{{workflowinstanceitem.id }}">
        <td colspan="3">
			<div class="detail_on_item">
				<div class="title_detail_item">
					<a title="Details" onclick="_show_commentOrDetail(this, 'detail'); return false;" href="."><b>Details</b></a>
					&nbsp;/&nbsp;
					<a title="Comments" onclick="_show_commentOrDetail(this, 'comment'); return false;" href=".">Comments</a>
				</div>
				<div class="all_for_detail">
					<pre class="details_item" id="details_item-{{ workflowinstanceitem.id }}"></pre>
					<form>
						<input type="submit" value="Edit detail"
						onclick="edit_details($('pre#details_item-{{ workflowinstanceitem.id }}')); return false;"
						style="width:25%;"/>
					</form>
					<div class="add_details">
					<h2>Edit details</h2>
					<form onsubmit="changeDetailsOrAddComment('detail', this); return false;" method=POST>
						<textarea class="textarea_edit_detail" rows="30" cols="125" name="new_details"></textarea>
						<input type="submit" value="Post" name="_post" style="width: 25%;"/>
					</form>
					</div>
				</div>
				<div class="all_for_comment">
					<pre class="comments_item" id="comments_item-{{ workflowinstanceitem.id }}"></pre>
					<div class="add_comment">
					<h2>Add comment</h2>
						<form onsubmit="changeDetailsOrAddComment('comment', this); return false;" method=POST>
							<textarea class="textarea_add_comment" rows="15" cols="125" name="new_comment"></textarea>
							<input type="submit" value="Post comment" style="width: 25%;"/>
						</form>
					</div>
				</div>
			</div>
		</td>
    </tr>
{% endfor %}
</table>
{% endifequal %}
{% endfor %}
{% endfor %}
</div>
</div>
{% endblock content %}
