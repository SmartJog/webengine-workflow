{% extends "workflow/base.html" %}
{% load parse_ticket %}
{% load smart_if %}

{% block optional_js %}
<script src="/javascript/underscore/underscore.min.js" type="text/javascript"></script>
<script src="/javascript/backbone/backbone.min.js" type="text/javascript"></script>
<script src="/javascript/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>

<script src="/medias/workflow/js/backbone_structure.js" type="text/javascript"></script>
<script src="/medias/workflow/js/progressbar.js" type="text/javascript"></script>
<script src="/medias/workflow/js/shortcut.js" type="text/javascript"></script>
<script src="/medias/workflow/js/common.js" type="text/javascript"></script>
<script src="/medias/workflow/js/compute.js" type="text/javascript"></script>
<script src="/medias/workflow/js/errors.js" type="text/javascript"></script>
{% endblock %}

{% block title %}{{ workflowinstance }}{% endblock %}

{% block content %}
<script type="text/javascript">
/* Global variables */
var gl_total = {{ counter.Total }};
var gl_failed = {{ counter.Failed }};
var gl_success = {{ counter.Success }};
var gl_taken = {{ counter.Taken }};
var gl_untaken = {{ counter.Free }};
var gl_not_solved = {{ counter.NotSolved }};
var gl_mine = {{ counter.Mine }};
/* ***** */
</script>
<!-- Progressbar and stats which are generated by javascript -->
<div class="progress_workflow">
	<div id="progress_bar">
	</div>
	<div class="progress_bar_stats">
	<ul>
		<li><span id="stats-success"></span></li>
		<li><span id="stats-failed"></span></li>
		<li><span id="stats-unsolved"></span></li>
	</ul>
	</div>
</div>
<!-- ** -->

<!-- Items filters -->
<div class="filters_workflow">
	<label><input type="radio" id="filters-all" onClick="$(location).attr('href','{% url workflow-show workflow_id display.all %}');" /><span></span></label>
	<label><input type="radio" id="filters-mine" onClick="$(location).attr('href','{% url workflow-show workflow_id display.mine %}');" /><span></span></label>
	<label><input type="radio" id="filters-untaken" onClick="$(location).attr('href','{% url workflow-show workflow_id display.untaken %}');" /><span></span></label>
	<label><input type="radio" id="filters-taken" onClick="$(location).attr('href','{% url workflow-show workflow_id display.taken %}');" /><span></span></label>
	<label><input type="radio" id="filters-successful" onClick="$(location).attr('href','{% url workflow-show workflow_id display.successful %}');" /><span></span></label>
	<label><input type="radio" id="filters-failed" onClick="$(location).attr('href','{% url workflow-show workflow_id display.failed %}');" /><span></span></label>
</div>
<!-- ** -->

<div class="categories_table_workflow" id="workflowinstance_id-{{ workflow_id }}">
{% for id_category in order %}
{% for category in categories %}
{% ifequal id_category category.order %}
<table class="category_workflow" id="category_id-{{ category.id }}">
	<tr class="category-header">
	<th> -{{ category.name }} </th>
		<!-- Cell containing take and untake links for the whole group of items -->
		<td class="take_untake_group" id="category_group-{{category.id}}">
			<a class="take-group" title="Take all items of the category" href="" onclick="return false;">take</a>&nbsp;/&nbsp;
			<a class="untake-group" title="Untake all items of the category" href="" onclick="return false;">untake</a>
		</td>
		<!-- ** -->
	</tr>
	{% for item in category.items %}
	<tr class="highlight {% if forloop.counter|divisibleby:2 %}{% else %}odd_line{% endif %}">
	<!-- Cell containing label of the item -->
	<td id="label-item-{{ item.id }}" class="label">
		<a class="label_item" title="Label item" href="" onclick="return false;">{{ forloop.counter }} - {{ item.label }}</a>
		{% for URL in item.label|link_ticket %}
			{% ifequal forloop.counter 1 %}|&nbsp;{% endifequal %}
			<a class="urls" href="{{ URL }}" alt="Ticket {{ URL }}">{{ URL|get_ticket_name }}</a>{% if not forloop.last %},{% endif %}
		{% endfor %}
	</td>
	<!-- ** -->

	<!-- Cell containing owner of the item -->
	{% ifequal item.assigned_to None %}
		<td class="take-item owner-{{ item.assigned_to_id }}" id="take-item-{{ item.id }}">
			<a title="Take item" href="" onclick="return false;">take</a>
		</td>
	{% else %}
		<td class="untake-item owner-{{ item.assigned_to_id }}" id="untake-item-{{ item.id }}">
			{{ item.assigned_to }}
			<a title="Reset owner of item" href="" onclick="return false;">
			<img src="/medias/workflow/img/untake.png" />
			</a>
		</td>
	{% endifequal %}
	<!-- ** -->

	<!-- Cell containing validation of the item -->
	<td id="action-validation-{{ item.id }}" class="state-item-{{ item.validation }} validation-cell">
		{% ifequal validations.0 item.validation %}
			<a title="Item is validated">
			<img src="/medias/workflow/img/validation_OK.png" alt="enabled" />
			</a>
		{% else %}
			<a class="validation-disabled-OK validation" title="Click to validate" href="" onclick="return false;">
			<img src="/medias/workflow/img/validation_OK_disabled.png" alt="enabled" />
			</a>
		{% endifequal %}

		{% if validations.1.label == item.validation.label or validations.2.label == item.validation.label%}
			<a title="Item is untested"><span> ? </span></a>
		{% else %}
			<a class="validation-disabled-None validation" title="Reset item validation" href="" onclick="return false;"><span> ? </span></a>
		{% endif %}

		{% ifequal validations.1 item.validation %}
			<a title="Item is broken">
			<img src="/medias/workflow/img/validation_KO.png" alt="enabled" />
			</a>
		{% else %}
			<a class="validation-disabled-KO validation" title="Click to mark as broken" href="" onclick="return false;">
			<img src="/medias/workflow/img/validation_KO_disabled.png" alt="enabled" />
			</a>
		{% endifequal %}
	</td>
	</tr>
	<!-- ** -->

	<!-- Details and comments of the item -->
	<tr id="detail-item-{{item.id }}">
	<td colspan="3">
		<div class="detail_on_item">
			<div class="title_detail_item">
				<a title="Details" onclick="_show_commentOrDetail(this, 'detail'); return false;" href="."><b>Details</b></a>
					&nbsp;/&nbsp;
				<a title="Comments" onclick="_show_commentOrDetail(this, 'comment'); return false;" href=".">Comments</a>
			</div>
			<div class="all_for_detail">
				<pre class="details_item" id="details_item-{{ item.id }}"></pre>
				<form>
					<input type="submit" value="Edit detail"
					onclick="edit_details($('pre#details_item-{{ item.id }}')); return false;"
					style="width:25%;"/>
				</form>
				<div class="add_details">
					<h2>Edit details</h2>
					<form onsubmit="changeDetailsOrAddComment('detail', this); return false;" method=POST>
						<textarea class="textarea_edit_detail" rows="7" cols="75" name="new_details"></textarea>
						<br />
						<input type="submit" value="Post" name="_post" style="width: 25%;"/>
					</form>
					</div>
				</div>
				<div class="all_for_comment">
					<pre class="comments_item" id="comments_item-{{ item.id }}"></pre>
					<div class="add_comment">
					<h2>Add comment</h2>
					<form onsubmit="changeDetailsOrAddComment('comment', this); return false;" method=POST>
						<textarea class="textarea_add_comment" rows="7" cols="75" name="new_comment"></textarea>
						<br />
						<input type="submit" value="Post comment" style="width: 25%;"/>
					</form>
				</div>
			</div>
		</div>
	</td>
	</tr>
	<!-- ** -->
	{% endfor %}
</table>
{% endifequal %}
{% endfor %}
{% endfor %}
</div>
<!-- Error box -->
<div id="dialogError" title="" style="visibility: hidden;">
	<p></p>
</div>
<!-- ** -->
{% endblock content %}
