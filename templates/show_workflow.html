{% extends "workflow/base.html" %}
{% load parse_ticket %}
{% load smart_if %}

{% block optional_js %}
<script src="/javascript/underscore/underscore.min.js" type="text/javascript"></script>
<script src="/javascript/backbone/backbone.min.js" type="text/javascript"></script>
<script src="/javascript/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>

<script src="/medias/workflow/js/backbone_structure.js" type="text/javascript"></script>
<script src="/medias/workflow/js/progressbar.js" type="text/javascript"></script>
<script src="/medias/workflow/js/common.js" type="text/javascript"></script>
<script src="/medias/workflow/js/compute.js" type="text/javascript"></script>
<script src="/medias/workflow/js/errors.js" type="text/javascript"></script>
{% endblock %}

{% block title %}{{ workflowinstance }}{% endblock %}

{% block content %}
<script type="text/javascript">
/* Global variables */
var gl_total = {{ counter.Total }};
var gl_failed = {{ counter.Failed }};
var gl_success = {{ counter.Success }};
var gl_taken = {{ counter.Taken }};
var gl_untaken = {{ counter.Free }};
var gl_not_solved = {{ counter.NotSolved }};
var gl_mine = {{ counter.Mine }};
var gl_myId = {{ myId }};
var gl_workflowId = {{ workflow_id }};
/* ***** */
</script>
<!-- Progressbar and stats which are generated by javascript -->
<div class="progress_workflow">
	<div id="progress_bar">
	</div>
	<div class="progress_bar_stats">
	<ul>
		<li><span id="stats-success"></span></li>
		<li><span id="stats-failed"></span></li>
		<li><span id="stats-unsolved"></span></li>
	</ul>
	</div>
</div>
<!-- ** -->

<!-- Items filters -->
<div class="filters_workflow">
	<label><input type="radio" id="filters-all" onClick="$(location).attr('href','{% url workflow-show workflow_id display.all %}');" /><span></span></label>
	<label><input type="radio" id="filters-mine" onClick="$(location).attr('href','{% url workflow-show workflow_id display.mine %}');" /><span></span></label>
	<label><input type="radio" id="filters-untaken" onClick="$(location).attr('href','{% url workflow-show workflow_id display.untaken %}');" /><span></span></label>
	<label><input type="radio" id="filters-taken" onClick="$(location).attr('href','{% url workflow-show workflow_id display.taken %}');" /><span></span></label>
	<label><input type="radio" id="filters-successful" onClick="$(location).attr('href','{% url workflow-show workflow_id display.successful %}');" /><span></span></label>
	<label><input type="radio" id="filters-failed" onClick="$(location).attr('href','{% url workflow-show workflow_id display.failed %}');" /><span></span></label>
</div>
<!-- ** -->

<div class="categories_table_workflow">
{% for id_category in order %}
{% for category in categories %}
{% ifequal id_category category.order %}
<table class="category_workflow" id="category_id-{{ category.id }}">
	<tr class="category-header">
	<th>{{ forloop.counter }} -{{ category.name }} </th>
		<!-- Cell containing take and untake links for the whole group of items -->
		<td class="take_untake_group">
			<a class="take-group" title="Take all items of the category" href="" onclick="return false;">take</a>&nbsp;/&nbsp;
			<a class="untake-group" title="Untake all items of the category" href="" onclick="return false;">untake</a>
		</td>
		<td>&nbsp;</td>
		<!-- ** -->
	</tr>
	{% for item in category.items %}
	<tr><td colspan="3">
	<table class="item_table">
	<tr class="highlight {% if forloop.counter|divisibleby:2 %}{% else %}odd_line{% endif %}" id="item-{{ item.id }}">
	<!-- Cell containing label of the item -->
	<td class="label">
		<a class="label_item" title="Label item" href="" onclick="return false;">{{ forloop.counter }} - {{ item.label }}</a>
		{% for URL in item.label|link_ticket %}
			{% ifequal forloop.counter 1 %}|&nbsp;{% endifequal %}
			<a class="urls" href="{{ URL }}" alt="Ticket {{ URL }}">{{ URL|get_ticket_name }}</a>{% if not forloop.last %},{% endif %}
		{% endfor %}
	</td>
	<!-- ** -->

	<!-- Cell containing owner of the item -->
		<td class="take-item untake-item {% ifequal item.assigned_to None %} is-untaken {% else %} is-taken {% endifequal %}">
			<a title="Take item" href="" onclick="return false;" class='untake'>take</a>
			<a title="Reset owner of item" href="" onclick="return false;" class='take'>
			<span>{{ item.assigned_to }}</span>
			<img src="/medias/workflow/img/untake.png" />
			</a>
		</td>
	<!-- ** -->

	<!-- Cell containing validation of the item -->
	<td class="validation-cell">
			<a title="Item is validated" class='validation-OK validation-enabled'>
			<img src="/medias/workflow/img/validation_OK.png" alt="enabled" />
			</a>
			<a class="validation-OK validation validation-disabled" title="Click to validate" href="" onclick="return false;">
			<img src="/medias/workflow/img/validation_OK_disabled.png" alt="enabled" />
			</a>

			<a title="Item is untested" class='validation-None validation-enabled'><span> ? </span></a>
			<a class="validation-None validation validation-disabled" title="Reset item validation" href="" onclick="return false;"><span> ? </span></a>

			<a title="Item is broken" class='validation-KO validation-enabled'>
			<img src="/medias/workflow/img/validation_KO.png" alt="enabled" />
			</a>
			<a class="validation-KO validation validation-disabled" title="Click to mark as broken" href="" onclick="return false;">
			<img src="/medias/workflow/img/validation_KO_disabled.png" alt="enabled" />
			</a>
	</td>
	</tr>
	<!-- ** -->
	<!-- Details and comments of the item -->
	<tr id="detail-item-{{item.id }}">
	<td colspan="3">
		<div class="detail_on_item">
			<div class="title_detail_item">
				<a title="Details" onclick="return false;" href="." class="title_details">Details</a>
					&nbsp;/&nbsp;
				<a title="Comments" onclick="return false;" href="." class="title_comment">Comments</a>
			</div>
			<div class='all_for_detail'>
				<pre class='details_item'></pre>
				<button onclick='return false;' class='edit_details'>Edit details</button>
				<div class='add_details'>
					<h2>Edit details</h2>
					<textarea class='textarea_edit_detail' rows='7' cols='75' name='new_details'></textarea><br />
					<button type='button' onclick='return false;' class='details'>Post</button>
				</div>
			</div>
			<div class='all_for_comment'>
				<pre class='comments_item'></pre>
				<div class='add_comment'>
					<h2>Add comment</h2>
					<textarea class='textarea_add_comment' rows='7' cols='75' name='new_comment'></textarea><br />
					<button type='button' onclick='return false;' class='comment'>Post</button>
				</div>
			</div>
		</div>
	</td>
	</tr>
	<!-- ** -->
	</table>
	</td></tr>
	{% endfor %}
</table>
{% endifequal %}
{% endfor %}
{% endfor %}
</div>
<!-- Error box -->
<div id="dialogError" title="" style="visibility: hidden;">
	<p></p>
</div>
<!-- ** -->
{% endblock content %}
