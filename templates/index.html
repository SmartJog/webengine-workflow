{% extends "workflow/base.html" %}

{% block title %}Workflow Management{% endblock %}
{% block pagetitle %}Workflow Management{% endblock %}

{% block optional_js %}
<script src='/javascript/jquery-ui/jquery-ui.min.js' type='text/javascript'></script>
<script type='text/javascript'>
function deleteWorkflow(workflowId) {
    var dialog = $('#dialog-delete-workflow');
    dialog.addClass('visibile').removeClass('hidden');
    instanceLabel = $('li#instance-' + workflowId + ' a:first-child').html();
    var message = 'This action is irrecoverable !<br />Are you sure to delete <b>' + instanceLabel + '</b> ?';
    dialog.find('p').html(message);
    dialog.dialog({
        open      : function() { dialog.parents('.ui-dialog-buttonpane button:eq(0)').focus(); },
        resizable : false,
        modal     : true,
        buttons   : {
            'Delete workflow': function() {
                dialog.find('p').html('Processing...');
                $.post(
                    '/workflow/delete/',
                    JSON.stringify({'workflow_id' : workflowId}),
                    function (data) {
                        if ($('li#instance-' + workflowId).parent().find('li').length === 1) {
                            $('li#instance-' + workflowId).parents('div.workflow_list').remove();
                        }
                        $('li#instance-' + workflowId).remove();
                        dialog.dialog('close');
                    }
                );
            },
            'Cancel': function() { dialog.dialog('close'); }
        }
    });
}

function deleteSection(sectionId) {
    var dialog = $('#dialog-delete-section');
    dialog.addClass('visibile').removeClass('hidden');
    instanceLabel = $('div#section-' + sectionId + ' h2').html();
    var message = 'This action is irrecoverable !<br />Are you sure to delete <b>' + instanceLabel + '</b> ?';
    dialog.find('p').html(message);
    dialog.dialog({
        open      : function() { dialog.parents('.ui-dialog-buttonpane button:eq(0)').focus(); },
        resizable : false,
        modal     : true,
        buttons   : {
            'Delete section': function() {
                dialog.find('p').html('Processing...');
                $.post(
                    '/workflow/delete/',
                    JSON.stringify({'section_id' : sectionId}),
                    function (data) {
                        $('div#section-' + sectionId).remove();
                        dialog.dialog('close');
                    }
                );
            },
            'Cancel': function() { dialog.dialog('close'); }
        }
    });
}

function copyWorkflow(workflowId) {
    var dialog = $('#dialog-copy-workflow');
    dialog.addClass('visibile').removeClass('hidden');
    var instanceLabel = $('li#instance-' + workflowId + ' a:first-child').html();
    var message = instanceLabel + '_copy';
    dialog.find('input[name=label]').attr('value', message);
    dialog.dialog({
        open      : function() { dialog.find('input[type=text]').focus(); },
        title     : 'Copy workflow ' + instanceLabel,
        resizable : true,
        modal     : true,
        width     : 500,
        buttons   : {
            'Copy': function() {
                if (dialog.find('input[name=label]').attr('value')
                   && (dialog.find('input[name=new_section]').attr('value')
                   || dialog.find('input[name=new_section]').attr('readonly') === true)) {
                    dialog.find('p').html('Processing...');
                    dialog.find('form').hide();
                    $.post(
                        '/workflow/copy/',
                        dialog.find('form').serialize() + '&workflow_id=' + workflowId,
                        function () { window.location.reload(); }
                    );
                }
            },
            'Cancel': function() { dialog.dialog('close'); }
        }
    });
}

function renameWorkflow(workflowId) {
    var dialog = $('#dialog-rename-workflow');
    dialog.addClass('visibile').removeClass('hidden');
    instanceLabel = $('li#instance-' + workflowId + ' a:first-child').html();
    var message = 'Current workflow name is: <b>' + instanceLabel + '</b><br /><br />';
    dialog.find('p').html(message);
    dialog.find('input[name=new_name]').attr('value', instanceLabel);
    dialog.dialog({
        open      : function() { dialog.find('input').focus(); },
        resizable : true,
        modal     : true,
        width     : 500,
        buttons   : {
            'Rename': function() {
                if (dialog.find('input[name=new_name]').attr('value')
                   && (dialog.find('input[name=new_section]').attr('value')
                   || dialog.find('input[name=new_section]').attr('readonly') === true)) {
                    dialog.find('p').html('Processing...');
                    dialog.find('form').hide();
                    $.post(
                        '/workflow/rename/',
                        dialog.find('form').serialize() + '&workflow_id=' + workflowId,
                        function () { window.location.reload(); }
                    );
                }
            },
            'Cancel': function() { dialog.dialog('close'); }
        }
    });
}

function createWorkflow() {
    var dialog = $('#dialog-create-workflow');
    dialog.removeClass('hidden').addClass('visible');
    dialog.dialog({
        open      : function() { dialog.find('input').focus(); },
        resizable : true,
        modal     : true,
        width     : 500,
        buttons   : {
            'Create': function() {
                if (dialog.find('input#new_workflow_name').attr('value')) {
                    dialog.find('p').html('Processing...');
                    dialog.find('form').hide();
                    $.post(
                        '/workflow/create/',
                        dialog.find('form').serialize(),
                        function () {
                            window.location.reload();
                        }
                    );
                }
            },
            'Cancel': function() { dialog.dialog('close'); }
        }
    });
}

function onChange (form) {
    if (form.find('select option:selected').attr('id') === 'new_section') {
        form.find('label#new_section_name input').removeAttr('readonly').removeClass('lock');
    } else {
        form.find('label#new_section_name input').removeAttr('value').attr('readonly', true).addClass('lock');
    }
}
</script>
{% endblock %}

{% block content %}
<div class="fullclass" id='workflow_management'>
    {% for section in workflow_sections %}
      {% if section.instances|length %}
      <div class='workflow_list'>
        <div id='section-{{ section.id }}'>
          <a onclick='deleteSection({{ section.id }});' title='Delete Workflow'>
            <img src='/medias/workflow/img/untake.png' class='untake' alt='Delete' />
          </a>
          <h2>{{ section.label }}</h2>
          <ul>
            {% for instance in section.instances %}
            <li class='highlight {% if forloop.counter|divisibleby:2 %}{% else %}odd_line{% endif %}' id='instance-{{ instance.id }}'>
            <a href='{% url workflow instance.id %}'>{{ instance.label }}</a>
            <span class='action_buttons'>
              <a onclick='renameWorkflow({{ instance.id }});' title='Rename Workflow'>
                <img src='/sjwebkit/common/images/famfamfam_icons/pencil.png' alt='Rename'/>
              </a>
              <a onclick='copyWorkflow({{ instance.id }});' title='Copy Workflow'>
                <img src='/sjwebkit/common/images/famfamfam_icons/layers.png' alt='Rename'/>
              </a>
              <a onclick='deleteWorkflow({{ instance.id }});' title='Delete Workflow'>
                <img src='/medias/workflow/img/untake.png' class='untake' alt='Delete'/>
              </a>
            </span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  <br />
  <a onclick='createWorkflow();' title='Create Workflow' class='workflow_management'>Create Workflow</a>
</div>

<div id='dialog-delete-workflow' title='Delete workflow' class='hidden'>
  <p></p>
</div>
<div id='dialog-delete-section' title='Delete section' class='hidden'>
  <p></p>
</div>
<div id='dialog-copy-workflow' title='Copy workflow' class='hidden'>
  <p></p>
  <form onsubmit='return false;' action=''>
    <label>Section <select name='section' onchange="onChange($(this).parents('form'));">
      <option id='new_section'>New section ...</option>
      {% for section in workflow_sections %}
      <option value='{{ section.id }}'>{{ section.label }}</option>
      {% endfor %}
    </select></label><br/><br/>
    <label id='new_section_name'>New section name<br/><input type='text' name='new_section' style='width: 100%;' /></label><br/>
    Name: <input type='text' name='label' style='width: 100%;'/><br/><br />
    <label><input type='checkbox' name='reset_validation' /> Reset validation</label><br />
    <label><input type='checkbox' name='reset_owner' /> Reset owner</label><br />
    <label><input type='checkbox' name='reset_comments' /> Reset comments</label><br />
  </form>
</div>
<div id='dialog-rename-workflow' title='Rename workflow' class='hidden'>
  <p></p>
  <form onsubmit='return false;' action=''>
    <label>Section <select name='section' onchange="onChange($(this).parents('form'));">
      <option id='new_section'>New section ...</option>
      {% for section in workflow_sections %}
      <option value='{{ section.id }}'>{{ section.label }}</option>
      {% endfor %}
    </select></label><br/><br/>
    <label id='new_section_name'>New section name<br/><input type='text' name='new_section' style='width: 100%;' /></label><br/>
    <label>New name: <input type='text' name='new_name' style='width: 100%;'/></label><br/><br/>
  </form>
</div>
<div id='dialog-create-workflow' title='Create workflow' class='hidden'>
  <p></p>
  <form onsubmit='return false;' action=''>
    <label>Section <select name='section' onchange="onChange($(this).parents('form'));">
      <option id='new_section'>New section ...</option>
      {% for section in workflow_sections %}
      <option>{{ section.label }}</option>
      {% endfor %}
    </select></label><br/><br/>
    <label id='new_section_name'>New section name<br/><input type='text' name='new_section' style='width: 100%;' /></label><br/>
    <label>New workflow name<br/><input type='text' name='new_workflow' id='new_workflow_name' style='width: 100%;'/></label>
  </form>
</div>
{% endblock content %}
